import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Skeleton } from '@/components/ui/skeleton';
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { AlertCircle } from "lucide-react"

interface ServerStatus {
    online: boolean;
    players?: {
        online: number;
        max: number;
        list?: string[];
    };
    motd?: {
        raw: string;
        html: string;
    };
    version?: string;
    favicon?: string;
    error?: string; // Add error property
}

const MinecraftServerStatus = ({ serverAddress }: { serverAddress: string }) => {
    const [status, setStatus] = useState<ServerStatus | null>(null);
    const [loading, setLoading] = useState<boolean>(true);
    const [error, setError] = useState<string | null>(null); // State for fetch errors

    useEffect(() => {
        const fetchServerStatus = async () => {
            setLoading(true);
            setError(null); // Clear previous errors
            try {
                // Use a proxy to avoid CORS issues.  Important for browser-based requests.
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(`https://api.mcstatus.io/v2/server/status/${serverAddress}`)}`;
                const response = await fetch(proxyUrl);

                if (!response.ok) {
                    // Handle HTTP errors (e.g., 500, 404)
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data: ServerStatus = await response.json();
                if (data.error) { // Check for error from the mcstatus.io API
                    setError(data.error);
                }
                setStatus(data);
            } catch (error: any) {
                // Catch network errors, JSON parsing errors, and the error we threw above
                setError(error.message);
                setStatus({ online: false, error: error.message }); // Set status to offline with error
            } finally {
                setLoading(false);
            }
        };

        fetchServerStatus();
    }, [serverAddress]);

    const getFavicon = () => {
        if (status?.favicon) {
            return status.favicon;
        }
        // Fallback to a default Minecraft icon.
        return 'https://via.placeholder.com/64x64?text=Minecraft';
    };

    const motdText = status?.motd?.html
        ? <div dangerouslySetInnerHTML={{ __html: status.motd.html }} />
        : status?.motd?.raw || '無法取得伺服器資訊';

    return (
        <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-black p-4 sm:p-8">
            <div className="max-w-4xl mx-auto space-y-6">
                <h1 className="text-3xl sm:text-4xl md:text-5xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                    Minecraft 伺服器狀態
                </h1>

                <Card className="bg-white/5 backdrop-blur-lg border border-white/10 shadow-xl">
                    <CardHeader>
                        <CardTitle className="text-2xl font-semibold text-white flex items-center gap-2">
                            {loading ? (
                                <Skeleton className="w-8 h-8 rounded-full" />
                            ) : (
                                <img
                                    src={getFavicon()}
                                    alt="Server Favicon"
                                    className="w-8 h-8 rounded-full"
                                />
                            )}
                            {loading ? (
                                <Skeleton className="w-40 h-6" />
                            ) : status?.online ? (
                                <span className="text-green-400">線上</span>
                            ) : (
                                <span className="text-red-400">離線</span>
                            )}
                        </CardTitle>
                        <CardDescription className="text-gray-300">
                            伺服器位址: <span className="font-mono text-purple-300">{serverAddress}</span>
                        </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        {loading ? (
                            <div className="space-y-4">
                                <Skeleton className="h-8 w-full" />
                                <Skeleton className="h-6 w-3/4" />
                                <Skeleton className="h-6 w-1/2" />
                            </div>
                        ) : error ? (
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertTitle>連線錯誤</AlertTitle>
                                <AlertDescription>
                                    無法連線到伺服器: {error}
                                </AlertDescription>
                            </Alert>
                        ) : status ? (
                            <>
                                <div className="text-white">
                                    <h2 className="text-lg font-semibold">MOTD:</h2>
                                    <div className="p-4 rounded-lg bg-black/20 border border-white/10">
                                        {motdText}
                                    </div>
                                </div>
                                {status.online && (
                                    <>
                                        <div className="text-white">
                                            <h2 className="text-lg font-semibold">玩家人數:</h2>
                                            <p className="text-gray-300">
                                                {status.players?.online ?? 0} / {status.players?.max ?? '未知'}
                                            </p>
                                        </div>
                                        {status.players?.online && status.players.list && status.players.list.length > 0 && (
                                            <div className="text-white">
                                                <h2 className="text-lg font-semibold">線上玩家:</h2>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 p-4 rounded-lg bg-black/20 border border-white/10">
                                                    {status.players.list.map((player, index) => (
                                                        <span key={index} className="text-gray-300 truncate">
                                                            {player}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <div className="text-white">
                                            <h2 className="text-lg font-semibold">版本:</h2>
                                            <p className="text-gray-300">{status.version || '未知'}</p>
                                        </div>
                                    </>
                                )}
                            </>
                        ) : (
                            <p className="text-gray-400">
                                無法取得伺服器狀態。請確認伺服器位址是否正確。
                            </p>
                        )}
                        <Button
                            variant="outline"
                            className="bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 border-purple-500/30"
                            onClick={() => window.location.reload()}
                        >
                            重新整理
                        </Button>
                    </CardContent>
                </Card>
            </div>
        </div>
    );
};

const App = () => {
    // Replace with your actual server address
    const serverAddress = 'andrewcho970531.ngrok.io';

    return (
        <MinecraftServerStatus serverAddress={serverAddress} />
    );
};

export default App;
