--- START OF FILE map.html ---

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet 中文地圖範例 (高雄)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- 鎖定函式庫的穩定版本 -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.21/leaflet-maplibre-gl.js"></script>

  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #style-switcher {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65);
    }
    #style-switcher button {
      margin: 2px;
      padding: 5px 10px;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: #fff;
    }
    #style-switcher button:hover {
      background-color: #f4f4f4;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="style-switcher">
  <button id="colorful">Colorful</button> <!-- 新增 Colorful 按鈕 -->
  <button id="positron">Positron</button>
  <button id="bright">Bright</button>
  <button id="liberty">Liberty</button>
  <button id="3d">3D</button>
</div>

<script>
  // 樣式檔 URL 列表
  const styleUrls = {
    colorful: 'https://cmok.openstreetmap.org/demo/shortbread/colorful.json', // 圖磚來源: cmok.openstreetmap.org
    liberty: 'https://tiles.openfreemap.org/styles/liberty',
    positron: 'https://tiles.openfreemap.org/styles/positron',
    bright: 'https://tiles.openfreemap.org/styles/bright',
    '3d': 'https://tiles.openfreemap.org/styles/liberty' // 3D 模式使用 Liberty 風格
  };

  let map;
  let maplibreGLLayer;

  // 切換樣式的函式
  async function switchStyle(styleUrl) {
    const response = await fetch(styleUrl);
    const style = await response.json();

    // 取得樣式檔的來源網域，用於解析相對路徑
    // 例如: "https://cmok.openstreetmap.org"
    const styleOrigin = new URL(styleUrl).origin; 

    // 修正 glyphs 的相對路徑
    if (style.glyphs && typeof style.glyphs === 'string' && style.glyphs.startsWith('/')) {
      style.glyphs = styleOrigin + style.glyphs;
    }

    // 修正 sprite 的相對路徑（考慮到 sprite 可能是物件陣列或單一字串）
    if (Array.isArray(style.sprite)) {
      style.sprite = style.sprite.map(s => {
        if (s.url && typeof s.url === 'string' && s.url.startsWith('/')) {
          return { ...s, url: styleOrigin + s.url };
        }
        return s;
      });
    } else if (style.sprite && typeof style.sprite === 'string' && style.sprite.startsWith('/')) {
      style.sprite = styleOrigin + style.sprite;
    }

    // *** 新增的修正：處理 sources 中的 tiles 絕對路徑 ***
    if (style.sources) {
      for (const sourceId in style.sources) {
        const source = style.sources[sourceId];
        // 檢查是否為 vector 或 raster 類型的 source，且有 tiles 屬性
        if ((source.type === 'vector' || source.type === 'raster') && source.tiles && Array.isArray(source.tiles)) {
          source.tiles = source.tiles.map(tileUrl => {
            if (typeof tileUrl === 'string' && tileUrl.startsWith('/')) {
              // 將相對路徑轉換為絕對路徑
              return styleOrigin + tileUrl;
            }
            return tileUrl;
          });
        }
      }
    }
    // *** 結束新增的修正 ***

    // 遍歷所有圖層，修改 text-field 規則，使其優先顯示中文
    for (const layer of style.layers) {
      if (layer.layout && layer.layout['text-field']) {
        layer.layout['text-field'] = [
          'coalesce',
          ['get', 'name:zh-Hant'], // 優先：繁體中文
          ['get', 'name:zh'],      // 其次：通用中文
          ['get', 'name:en'],      // 再次：英文
          ['get', 'name']        // 最後：預設名稱
        ];
      }
    }
    
    // 如果已有圖層，則設定新的樣式，否則就建立新圖層
    if (maplibreGLLayer) {
      maplibreGLLayer.getMaplibreMap().setStyle(style);
    } else {
      maplibreGLLayer = L.maplibreGL({
        style: style,
        maplibreGLOptions: {
          crossOrigin: 'anonymous'
        }
      }).addTo(map);
    }
  }
  
  // 重設視角為 2D 俯瞰的函式
  function resetPitch() {
    const maplibreMap = maplibreGLLayer.getMaplibreMap();
    // 檢查目前視角是否傾斜
    if (maplibreMap.getPitch() !== 0) {
      // 使用 flyTo 平順地恢復視角
      maplibreMap.flyTo({ pitch: 0 });
    }
  }

  // 使用 async/await 語法來處理非同步的樣式載入和修改
  async function initializeMap() {
    // --- 初始化地圖 ---
    map = L.map('map').setView([22.680947, 120.317491], 19);

    // 初始載入 Colorful 樣式 (已修改為預設載入)
    await switchStyle(styleUrls.colorful);

    // --- 解決方案 2: 修正初始載入問題 ---
    // 在短暫延遲後，強制 Leaflet 重新計算地圖容器大小
    setTimeout(() => {
      map.invalidateSize();
    }, 100); // 100 毫秒的延遲通常足夠
  }

  // 執行地圖初始化函式
  initializeMap();
  
  // --- 為按鈕加上事件監聽器 ---

  // Colorful 按鈕: 切換樣式並恢復視角
  document.getElementById('colorful').addEventListener('click', () => {
    switchStyle(styleUrls.colorful);
    resetPitch();
  });

  // Positron 按鈕: 切換樣式並恢復視角
  document.getElementById('positron').addEventListener('click', () => {
    switchStyle(styleUrls.positron);
    resetPitch();
  });

  // Bright 按鈕: 切換樣式並恢復視角
  document.getElementById('bright').addEventListener('click', () => {
    switchStyle(styleUrls.bright);
    resetPitch();
  });

  // Liberty 按鈕: 切換樣式並恢復視角
  document.getElementById('liberty').addEventListener('click', () => {
    switchStyle(styleUrls.liberty);
    resetPitch();
  });

  // 3D 按鈕: 切換樣式並傾斜視角
  document.getElementById('3d').addEventListener('click', () => {
      switchStyle(styleUrls['3d']);
      const maplibreMap = maplibreGLLayer.getMaplibreMap();
      // 僅在視角為 0 時才飛至 3D 視角，避免重複觸發
      if (maplibreMap.getPitch() === 0) {
        maplibreMap.flyTo({pitch: 60, zoom: 17});
      }
  });

</script>

</body>
</html>